From 94bbe17282732a8152ca153f1b970356ee69f46c Mon Sep 17 00:00:00 2001
From: Matthias Koeppe <mkoeppe@math.ucdavis.edu>
Date: Tue, 1 Aug 2023 15:17:32 -0700
Subject: [PATCH 1/4] pkgs/sagemath*/MANIFEST.in: Exclude all__*.py files of
 other distributions

---
 pkgs/sagemath-bliss/MANIFEST.in         |  5 +++--
 pkgs/sagemath-categories/MANIFEST.in.m4 |  4 +++-
 pkgs/sagemath-coxeter3/MANIFEST.in      |  5 +++--
 pkgs/sagemath-environment/MANIFEST.in   | 12 ++++++++++--
 pkgs/sagemath-mcqd/MANIFEST.in          |  5 +++--
 pkgs/sagemath-meataxe/MANIFEST.in       |  5 +++--
 pkgs/sagemath-objects/MANIFEST.in       |  4 ++--
 pkgs/sagemath-repl/MANIFEST.in          |  5 +++--
 pkgs/sagemath-sirocco/MANIFEST.in       |  5 +++--
 pkgs/sagemath-tdlib/MANIFEST.in         |  5 +++--
 10 files changed, 36 insertions(+), 19 deletions(-)

diff --git a/pkgs/sagemath-bliss/MANIFEST.in b/pkgs/sagemath-bliss/MANIFEST.in
index 689b87560e0..6d981b9d30e 100644
--- a/pkgs/sagemath-bliss/MANIFEST.in
+++ b/pkgs/sagemath-bliss/MANIFEST.in
@@ -1,5 +1,3 @@
-global-include all__sagemath_bliss.py
-
 include VERSION.txt
 
 graft sage/graphs/bliss_cpp
@@ -7,6 +5,9 @@ graft sage/graphs/bliss_cpp
 global-exclude *.c
 global-exclude *.cpp
 
+global-exclude all__sagemath_*.*
+global-include all__sagemath_bliss.py
+
 global-exclude __pycache__
 global-exclude *.py[co]
 global-exclude *.bak
diff --git a/pkgs/sagemath-categories/MANIFEST.in.m4 b/pkgs/sagemath-categories/MANIFEST.in.m4
index 361132e0cfa..b2e35673ec0 100644
--- a/pkgs/sagemath-categories/MANIFEST.in.m4
+++ b/pkgs/sagemath-categories/MANIFEST.in.m4
@@ -3,7 +3,6 @@ prune sage
 
 include VERSION.txt
 
-global-include all__sagemath_categories.py
 graft sage/categories
 # Exclude what is already shipped in sagemath-objects
 exclude sage/categories/action.*
@@ -42,6 +41,9 @@ graft sage/typeset                     # dep of sage.categories.tensor
 global-exclude *.c
 global-exclude *.cpp
 
+global-exclude all__sagemath_*.*
+global-include all__sagemath_categories.py
+
 global-exclude __pycache__
 global-exclude *.py[co]
 global-exclude *.bak
diff --git a/pkgs/sagemath-coxeter3/MANIFEST.in b/pkgs/sagemath-coxeter3/MANIFEST.in
index 003ab8d5180..a69f2e71363 100644
--- a/pkgs/sagemath-coxeter3/MANIFEST.in
+++ b/pkgs/sagemath-coxeter3/MANIFEST.in
@@ -1,7 +1,5 @@
 prune sage
 
-global-include all__sagemath_coxeter3.py
-
 include VERSION.txt
 
 graft sage/libs/coxeter3
@@ -9,6 +7,9 @@ graft sage/libs/coxeter3
 global-exclude *.c
 global-exclude *.cpp
 
+global-exclude all__sagemath_*.*
+global-include all__sagemath_coxeter3.py
+
 global-exclude __pycache__
 global-exclude *.py[co]
 global-exclude *.bak
diff --git a/pkgs/sagemath-environment/MANIFEST.in b/pkgs/sagemath-environment/MANIFEST.in
index 36f8fae1845..ca4266e2bf4 100644
--- a/pkgs/sagemath-environment/MANIFEST.in
+++ b/pkgs/sagemath-environment/MANIFEST.in
@@ -1,7 +1,5 @@
 prune sage
 
-global-include all__sagemath_environment.py
-
 include sage/env.py
 include sage/version.py
 include sage/misc/package.py
@@ -12,4 +10,14 @@ graft sage/features
 
 include VERSION.txt
 
+global-exclude all__*.py
+global-include all__sagemath_environment.py
+
+global-exclude __pycache__
 global-exclude *.py[co]
+global-exclude *.bak
+global-exclude *.so
+global-exclude *~
+prune .tox
+prune build
+prune dist
diff --git a/pkgs/sagemath-mcqd/MANIFEST.in b/pkgs/sagemath-mcqd/MANIFEST.in
index 392d97b78e0..801e1b3e48d 100644
--- a/pkgs/sagemath-mcqd/MANIFEST.in
+++ b/pkgs/sagemath-mcqd/MANIFEST.in
@@ -1,7 +1,5 @@
 prune sage
 
-global-include all__sagemath_mcqd.py
-
 include VERSION.txt
 
 include sage/graphs/mcqd.p*
@@ -9,6 +7,9 @@ include sage/graphs/mcqd.p*
 global-exclude *.c
 global-exclude *.cpp
 
+global-exclude all__sagemath_*.*
+global-include all__sagemath_mcqd.py
+
 global-exclude __pycache__
 global-exclude *.py[co]
 global-exclude *.bak
diff --git a/pkgs/sagemath-meataxe/MANIFEST.in b/pkgs/sagemath-meataxe/MANIFEST.in
index 4cf78dd5d02..c69ce68fc40 100644
--- a/pkgs/sagemath-meataxe/MANIFEST.in
+++ b/pkgs/sagemath-meataxe/MANIFEST.in
@@ -1,7 +1,5 @@
 prune sage
 
-global-include all__sagemath_meataxe.py
-
 include VERSION.txt
 
 include sage/libs/meataxe.p*
@@ -10,6 +8,9 @@ include sage/matrix/matrix_gfpn_dense.p*
 global-exclude *.c
 global-exclude *.cpp
 
+global-exclude all__sagemath_*.*
+global-include all__sagemath_meataxe.py
+
 global-exclude __pycache__
 global-exclude *.py[co]
 global-exclude *.bak
diff --git a/pkgs/sagemath-objects/MANIFEST.in b/pkgs/sagemath-objects/MANIFEST.in
index 00c5e0dc4a1..98b6910849a 100644
--- a/pkgs/sagemath-objects/MANIFEST.in
+++ b/pkgs/sagemath-objects/MANIFEST.in
@@ -3,8 +3,6 @@ graft sage/cpython
 
 include VERSION.txt
 
-global-include all__sagemath_objects.py
-
 graft sage/structure
 include sage/categories/action.*
 include sage/categories/algebra_functor.*
@@ -85,6 +83,8 @@ graft sage/libs/gmp
 include sage/misc/misc.*                # some_tuples used in sage.misc.sage_unittest
 include sage/misc/timing.p*             # walltime, cputime used in sage.doctest
 
+global-exclude all__*.py
+global-include all__sagemath_objects.py
 
 global-exclude *.c
 global-exclude *.cpp
diff --git a/pkgs/sagemath-repl/MANIFEST.in b/pkgs/sagemath-repl/MANIFEST.in
index c54f63b15ee..ba331ec2931 100644
--- a/pkgs/sagemath-repl/MANIFEST.in
+++ b/pkgs/sagemath-repl/MANIFEST.in
@@ -1,7 +1,5 @@
 prune sage
 
-global-include all__sagemath_repl.py
-
 graft sage/doctest
 graft sage/repl
 include sage/misc/banner.py
@@ -11,6 +9,9 @@ include sage/misc/sage_eval.py
 
 include VERSION.txt
 
+global-exclude all__*.py
+global-include all__sagemath_repl.py
+
 global-exclude __pycache__
 global-exclude *.py[co]
 global-exclude *.bak
diff --git a/pkgs/sagemath-sirocco/MANIFEST.in b/pkgs/sagemath-sirocco/MANIFEST.in
index 7fab4dffc5d..815a868524d 100644
--- a/pkgs/sagemath-sirocco/MANIFEST.in
+++ b/pkgs/sagemath-sirocco/MANIFEST.in
@@ -1,10 +1,11 @@
-global-include all__sagemath_sirocco.py
-
 include VERSION.txt
 
 global-exclude *.c
 global-exclude *.cpp
 
+global-exclude all__sagemath_*.*
+global-include all__sagemath_sirocco.py
+
 global-exclude __pycache__
 global-exclude *.py[co]
 global-exclude *.bak
diff --git a/pkgs/sagemath-tdlib/MANIFEST.in b/pkgs/sagemath-tdlib/MANIFEST.in
index f3fbc97a588..614186d89ab 100644
--- a/pkgs/sagemath-tdlib/MANIFEST.in
+++ b/pkgs/sagemath-tdlib/MANIFEST.in
@@ -1,5 +1,3 @@
-global-include all__sagemath_tdlib.py
-
 include VERSION.txt
 
 global-exclude *.c
@@ -7,6 +5,9 @@ global-exclude *.cpp
 
 include sage/graphs/graph_decompositions/sage_tdlib.cpp
 
+global-exclude all__sagemath_*.*
+global-include all__sagemath_tdlib.py
+
 global-exclude __pycache__
 global-exclude *.py[co]
 global-exclude *.bak

From a8d6ef0720223ae7e3ce81590581db1bb2b3d586 Mon Sep 17 00:00:00 2001
From: Matthias Koeppe <mkoeppe@math.ucdavis.edu>
Date: Thu, 3 Aug 2023 16:57:07 -0700
Subject: [PATCH 2/4] pkgs/sagemath-standard/MANIFEST.in: Exclude all__*.py
 files belonging to distributions related to optional packages

---
 src/MANIFEST.in | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/src/MANIFEST.in b/src/MANIFEST.in
index 0f6e2a37890..02e05c34512 100644
--- a/src/MANIFEST.in
+++ b/src/MANIFEST.in
@@ -47,6 +47,14 @@ include sage/geometry/triangulation/functions.cc
 # Exclude extension modules shipped by optional packages
 exclude sage/graphs/bliss.pyx
 
+# Exclude all__*.py files belonging to distributions related to optional packages
+global-exclude all__sagemath_bliss.py
+global-exclude all__sagemath_coxeter3.py
+global-exclude all__sagemath_mcqd.py
+global-exclude all__sagemath_meataxe.py
+global-exclude all__sagemath_sirocco.py
+global-exclude all__sagemath_tdlib.py
+
 global-exclude __pycache__
 global-exclude *.py[co]
 global-exclude *.bak

From 2ce4a867f6b5a258846830afff3168823f1bca9f Mon Sep 17 00:00:00 2001
From: Matthias Koeppe <mkoeppe@math.ucdavis.edu>
Date: Thu, 3 Aug 2023 17:10:37 -0700
Subject: [PATCH 3/4] src/MANIFEST.in: Exclude files shipped by sagemath-bliss
 etc.

---
 src/MANIFEST.in | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/src/MANIFEST.in b/src/MANIFEST.in
index 02e05c34512..13e8d94917a 100644
--- a/src/MANIFEST.in
+++ b/src/MANIFEST.in
@@ -21,7 +21,6 @@ global-exclude *.cpp
 include sage/cpython/debugimpl.c
 include sage/graphs/base/boost_interface.cpp
 include sage/graphs/cliquer/cl.c
-include sage/graphs/graph_decompositions/sage_tdlib.cpp
 include sage/libs/eclib/wrap.cpp
 include sage/libs/linkages/padics/relaxed/flint_helper.c
 include sage/misc/inherit_comparison_impl.c
@@ -45,7 +44,13 @@ include sage/geometry/triangulation/data.cc
 include sage/geometry/triangulation/functions.cc
 
 # Exclude extension modules shipped by optional packages
-exclude sage/graphs/bliss.pyx
+exclude sage/graphs/bliss.p*
+prune sage/graphs/bliss_cpp
+prune sage/libs/coxeter3
+exclude sage/graphs/mcqd.p*
+exclude sage/libs/meataxe.p*
+exclude sage/matrix/matrix_gfpn_dense.p*
+exclude sage/graphs/graph_decompositions/sage_tdlib.cpp
 
 # Exclude all__*.py files belonging to distributions related to optional packages
 global-exclude all__sagemath_bliss.py

From cf02a4256ee8e630ec444452d1dfdd0dac7382cf Mon Sep 17 00:00:00 2001
From: Matthias Koeppe <mkoeppe@math.ucdavis.edu>
Date: Thu, 3 Aug 2023 17:33:09 -0700
Subject: [PATCH 4/4] src/MANIFEST.in: Exclude files shipped by sagemath-tdlib

---
 src/MANIFEST.in                                     | 1 +
 src/sage/graphs/graph_decompositions/sage_tdlib.cpp | 2 ++
 2 files changed, 3 insertions(+)

diff --git a/src/MANIFEST.in b/src/MANIFEST.in
index 13e8d94917a..2a26ec02dba 100644
--- a/src/MANIFEST.in
+++ b/src/MANIFEST.in
@@ -51,6 +51,7 @@ exclude sage/graphs/mcqd.p*
 exclude sage/libs/meataxe.p*
 exclude sage/matrix/matrix_gfpn_dense.p*
 exclude sage/graphs/graph_decompositions/sage_tdlib.cpp
+exclude sage/graphs/graph_decomposition/tdlib.p*
 
 # Exclude all__*.py files belonging to distributions related to optional packages
 global-exclude all__sagemath_bliss.py
diff --git a/src/sage/graphs/graph_decompositions/sage_tdlib.cpp b/src/sage/graphs/graph_decompositions/sage_tdlib.cpp
index ad1e3fb1f03..3644edf6ac7 100644
--- a/src/sage/graphs/graph_decompositions/sage_tdlib.cpp
+++ b/src/sage/graphs/graph_decompositions/sage_tdlib.cpp
@@ -1,3 +1,5 @@
+// sage.setup: distribution = sagemath-tdlib
+
 #include <boost/tuple/tuple.hpp>
 #include <map>
 
